<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Lovable-Light</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Container für Blöcke -->
  <div id="app">Lade Website...</div>

  <!-- Chatbox -->
  <div id="chatbox">
    <textarea id="chatInput" placeholder="Beschreibe deine Website wie ein Mensch..."></textarea>
    <button id="chatSend">Absenden</button>
  </div>

  <script>
    // =========================
    // Render-Funktion
    // =========================
    function renderPage(data) {
      document.title = data.pageTitle || "Neue Seite";
      const app = document.getElementById("app");
      app.innerHTML = "";

      data.blocks.forEach(block => {
        switch (block.type) {
          case "hero":
            app.innerHTML += `
              <section class="hero">
                <h1>${block.headline || ""}</h1>
                <p>${block.sub || ""}</p>
                <a href="${block.ctaLink || "#"}" class="btn">${block.ctaText || ""}</a>
              </section>`;
            break;

          case "features":
            const items = (block.items || []).map(i => `
              <div class="feature">
                <div class="icon">${i.icon || ""}</div>
                <h3>${i.title || ""}</h3>
                <p>${i.text || ""}</p>
              </div>`).join("");
            app.innerHTML += `
              <section class="features">
                <h2>Features</h2>
                <div class="features-grid">${items}</div>
              </section>`;
            break;

          case "text":
            app.innerHTML += `
              <section class="text-block">
                <h2>${block.title || ""}</h2>
                <p>${block.body || ""}</p>
              </section>`;
            break;

          case "gallery":
            const imgs = (block.images || []).map(img => `<img src="${img}" alt="Bild">`).join("");
            app.innerHTML += `
              <section class="gallery">
                <h2>Galerie</h2>
                <div class="grid">${imgs}</div>
              </section>`;
            break;

          case "faq":
            const faqs = (block.items || []).map(i => `
              <details>
                <summary>${i.q || ""}</summary>
                <p>${i.a || ""}</p>
              </details>`).join("");
            app.innerHTML += `
              <section class="faq">
                <h2>Häufige Fragen</h2>
                ${faqs}
              </section>`;
            break;

          case "button":
            app.innerHTML += `
              <div class="center">
                <button class="btn" style="background:${block.color || "blue"}">
                  ${block.text || "Button"}
                </button>
              </div>`;
            break;

          case "image":
            app.innerHTML += `
              <div class="image-block">
                <img src="${block.src}" alt="${block.alt || "Bild"}" />
              </div>`;
            break;

          case "footer":
            app.innerHTML += `
              <footer class="footer">
                <p>${block.text || ""}</p>
              </footer>`;
            break;

          default:
            app.innerHTML += `
              <section>
                <pre>${JSON.stringify(block, null, 2)}</pre>
              </section>`;
        }
      });
    }

    // =========================
    // Chatbox-Logik
    // =========================
    document.getElementById("chatSend").addEventListener("click", async () => {
      const input = document.getElementById("chatInput").value.trim();
      if (!input) return alert("Bitte etwas eingeben.");

      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ input })
      });

      const payload = await res.json();
      if (!res.ok) {
        alert("Fehler: " + (payload?.error || "Unbekannt"));
        console.error(payload);
        return;
      }

      localStorage.setItem("pageData", JSON.stringify(payload));
      renderPage(payload);
    });

    // =========================
    // Initial: data.json laden (falls vorhanden)
    // =========================
    const saved = localStorage.getItem("pageData");
    if (saved) {
      renderPage(JSON.parse(saved));
    } else {
      fetch("data.json")
        .then(r => r.ok ? r.json() : { pageTitle: "Startseite", blocks: [] })
        .then(renderPage);
    }
  </script>
</body>
</html>
