<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Lovable-Light</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Container f√ºr Bl√∂cke -->
  <div id="app">Lade Website...</div>

  <!-- Chatbox -->
  <div id="chatbox">
    <textarea id="chatInput" placeholder="Beschreibe deine Website wie ein Mensch..."></textarea>
    <button id="chatSend">Absenden</button>
  </div>

  <script>
    // =========================
    // Render-Funktion
    // =========================
    function renderPage(data) {
      console.log("üñºÔ∏è Rendere Seite mit JSON:", data);

      if (!data || !data.blocks) {
        document.getElementById("app").innerHTML = "<p style='color:red'>‚ö†Ô∏è Keine g√ºltigen Daten zum Rendern.</p>";
        return;
      }

      document.title = data.pageTitle || "Neue Seite";
      const app = document.getElementById("app");
      app.innerHTML = "";

      data.blocks.forEach(block => {
        switch (block.type) {
          case "hero":
            app.innerHTML += `
              <section class="hero">
                <h1>${block.headline || ""}</h1>
                <p>${block.sub || ""}</p>
                <a href="${block.ctaLink || "#"}" class="btn">${block.ctaText || ""}</a>
              </section>`;
            break;

          case "button":
            app.innerHTML += `
              <div class="center">
                <button class="btn" style="background:${block.color || "blue"}">
                  ${block.text || "Button"}
                </button>
              </div>`;
            break;

          case "footer":
            app.innerHTML += `
              <footer class="footer">
                <p>${block.text || ""}</p>
              </footer>`;
            break;

          default:
            console.warn("‚ö†Ô∏è Unbekannter Blocktyp:", block);
            app.innerHTML += `
              <section>
                <pre>${JSON.stringify(block, null, 2)}</pre>
              </section>`;
        }
      });
    }

    // =========================
    // Chatbox-Logik
    // =========================
    document.getElementById("chatSend").addEventListener("click", async () => {
      const input = document.getElementById("chatInput").value.trim();
      if (!input) return alert("Bitte etwas eingeben.");

      console.log("üì§ Sende an API:", input);

      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ input })
      });

      const payload = await res.json();
      console.log("üì• API Antwort:", payload);

      if (!res.ok) {
        alert("Fehler: " + (payload?.error || "Unbekannt"));
        console.error(payload);
        return;
      }

      localStorage.setItem("pageData", JSON.stringify(payload));
      renderPage(payload);
    });

    // =========================
    // Initial: data.json laden oder Fallback
    // =========================
    const saved = localStorage.getItem("pageData");
    if (saved) {
      console.log("‚ö° Lade gespeicherte Seite aus localStorage");
      renderPage(JSON.parse(saved));
    } else {
      console.log("üåç Lade data.json...");
      fetch("data.json")
        .then(r => {
          if (!r.ok) {
            console.warn("‚ö†Ô∏è Keine data.json gefunden, verwende Fallback");
            return {
              pageTitle: "Fallback-Seite",
              blocks: [
                { "type": "hero", "headline": "Hallo Ali", "sub": "Dies ist ein Fallback Hero", "ctaText": "Weiter", "ctaLink": "#" },
                { "type": "button", "text": "Jetzt starten", "color": "red", "link": "#" },
                { "type": "footer", "text": "¬© 2025 Lovable-Light" }
              ]
            };
          }
          return r.json();
        })
        .then(data => {
          console.log("‚úÖ data.json geladen oder Fallback genutzt:", data);
          renderPage(data);
        })
        .catch(err => {
          console.error("‚ùå Problem mit data.json:", err);
          renderPage({
            pageTitle: "Error-Seite",
            blocks: [
              { "type": "hero", "headline": "Fehler beim Laden", "sub": "data.json konnte nicht geladen werden", "ctaText": "Neu versuchen", "ctaLink": "#" },
              { "type": "footer", "text": "¬© 2025 Lovable-Light" }
            ]
          });
        });
    }
  </script>
</body>
</html>
